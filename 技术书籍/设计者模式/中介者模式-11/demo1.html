<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>中介者模式</title>
</head>

<body>
  <h3>中介者模式</h3>
  <p>游戏</p>
  <p>中介者模式的作用就是解除对象与对象之间的紧耦合关系。</p>
  <script>
    // 游戏中介者
    var playerDirector = (function () {
      var players = {}, // 保存所有玩家
        operations = {}; // 中介者可以执行的操作

      // 新增一个玩家
      operations.addPlayer = function (player) {
        var teamColor = player.teamColor;
        players[teamColor] = players[teamColor] || [];
        players[teamColor].push(player);
        console.log(players);
      };
      // 移除一个玩家
      operations.removePlayer = function (player) {
        var teamColor = player.teamColor, // 玩家的队伍颜色
          teamPlayers = players[teamColor] || []; // 该队伍所有成员
        for (var i = teamPlayers.length - 1; i >= 0; i--) { // 遍历删除
          if (teamPlayers[i] === player) {
            teamPlayers.splice(i, 1);
          }
        }
      };
      // 玩家换队
      operations.changeTeam = function (player, newTeamColor) {
        operations.removePlayer(player);
        player.teamColor = newTeamColor;
        operations.addPlayer(player);
      };
      // 玩家死亡
      operations.playerDead = function (player) { // 玩家死亡
        var teamColor = player.teamColor,
          teamPlayers = players[teamColor]; // 玩家所在队伍
        var all_dead = true;
        for (var i = 0, player; player = teamPlayers[i++];) {
          if (player.state !== 'dead') {
            all_dead = false;
            break;
          }
        }
        if (all_dead === true) { // 全部死亡
          for (var i = 0, player; player = teamPlayers[i++];) {
            player.lose(); // 本队所有玩家 lose
          }
          for (var color in players) {
            if (color !== teamColor) {
              var teamPlayers = players[color]; // 其他队伍的玩家
              for (var i = 0, player; player = teamPlayers[i++];) {
                player.win(); // 其他队伍所有玩家 win
              }
            }
          }
        }
      };

      var reciveMessage = function () {
        var message = Array.prototype.shift.call(arguments); // arguments 的第一个参数为消息名称
        operations[message].apply(this, arguments);
      };
      return {
        reciveMessage: reciveMessage
      }
    })();


    var Player = function (name, teamColor) {
      this.name = name;
      this.teamColor = teamColor;
    }

    var playerFactory = function (name, teamColor) {
      var newPlayer = new Player(name, teamColor); // 创造一个新的玩家对象
      playerDirector.reciveMessage('addPlayer', newPlayer); // 给中介者发送消息，新增玩家
      return newPlayer;
    };

    // 调用
    // 红队：
    var player1 = playerFactory('皮蛋', 'red'),
      player2 = playerFactory('小乖', 'red'),
      player3 = playerFactory('宝宝', 'red'),
      player4 = playerFactory('小强', 'red');
    // 蓝队：
    var player5 = playerFactory('黑妞', 'blue'),
      player6 = playerFactory('葱头', 'blue'),
      player7 = playerFactory('胖墩', 'blue');

  </script>
</body>

</html>
